<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>project V</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap');

        :root {
            --bg-primary: #0f1923;
            --bg-secondary: #1a242d;
            --bg-card: #1f2933;
            --accent-attack: #ff4655;
            --accent-defense: #00c8c8;
            --accent-gold: #ece8e1;
            --text-primary: #ece8e1;
            --text-secondary: #768079;
            --gradient-attack: linear-gradient(135deg, #ff4655, #bd3944);
            --gradient-defense: linear-gradient(135deg, #00c8c8, #00a0a0);
            --border-color: #2f3b47;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Rajdhani', 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            background-image:
                linear-gradient(rgba(15, 25, 35, 0.95), rgba(15, 25, 35, 0.95)),
                repeating-linear-gradient(0deg, transparent, transparent 50px, rgba(255, 255, 255, 0.02) 50px, rgba(255, 255, 255, 0.02) 51px),
                repeating-linear-gradient(90deg, transparent, transparent 50px, rgba(255, 255, 255, 0.02) 50px, rgba(255, 255, 255, 0.02) 51px);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .hidden {
            display: none !important;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .game-title {
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: 3px;
            color: var(--accent-attack);
        }

        .game-info {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .info-item {
            text-align: center;
        }

        .info-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .info-value {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .score-display {
            display: flex;
            gap: 15px;
        }

        .score-box {
            padding: 10px 25px;
            text-align: center;
            clip-path: polygon(10px 0, 100% 0, calc(100% - 10px) 100%, 0 100%);
        }

        .score-box.attack {
            background: var(--gradient-attack);
        }

        .score-box.defense {
            background: var(--gradient-defense);
            color: var(--bg-primary);
        }

        #title-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
            text-align: center;
        }

        .logo {
            font-size: 5rem;
            font-weight: 700;
            letter-spacing: 15px;
            color: var(--accent-attack);
            text-shadow: 0 0 60px rgba(255, 70, 85, 0.5);
        }

        .subtitle {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 50px;
            letter-spacing: 5px;
            text-transform: uppercase;
        }

        .btn {
            padding: 15px 50px;
            font-size: 1rem;
            font-weight: 700;
            font-family: 'Rajdhani', sans-serif;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
            clip-path: polygon(8px 0, 100% 0, calc(100% - 8px) 100%, 0 100%);
        }

        .btn-primary {
            background: var(--accent-attack);
            color: white;
        }

        .btn-primary:hover {
            filter: brightness(1.2);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .pick-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .pick-header h2 {
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: 3px;
        }

        .player-indicator {
            display: inline-block;
            padding: 8px 25px;
            font-weight: 700;
            letter-spacing: 2px;
            clip-path: polygon(8px 0, 100% 0, calc(100% - 8px) 100%, 0 100%);
        }

        .player-indicator.p1 {
            background: var(--gradient-attack);
        }

        .player-indicator.p2 {
            background: var(--gradient-defense);
            color: var(--bg-primary);
        }

        .agent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        /* VALORANTé¢¨ãƒ”ãƒƒã‚¯ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .pick-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            margin-bottom: 30px;
        }

        .agent-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            max-height: 500px;
            overflow-y: auto;
        }

        .agent-tile {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .agent-tile:hover {
            border-color: var(--accent-attack);
        }

        .agent-tile.active {
            border-color: var(--accent-attack);
            background: rgba(255, 70, 85, 0.1);
        }

        .agent-tile.picked {
            opacity: 0.3;
            pointer-events: none;
        }

        .agent-tile .tile-icon {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .agent-tile .tile-name {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .agent-detail {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 25px;
            min-height: 400px;
        }

        .detail-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 20px;
        }

        .detail-icon {
            font-size: 4rem;
        }

        .detail-name {
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: 2px;
        }

        .detail-abilities {
            margin-top: 20px;
        }

        .detail-ability {
            background: var(--bg-card);
            border-left: 3px solid var(--accent-attack);
            padding: 15px;
            margin-bottom: 12px;
        }

        .detail-ability-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-gold);
            margin-bottom: 5px;
        }

        .detail-ability-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .detail-ability-cost {
            font-size: 0.85rem;
            color: var(--accent-attack);
        }

        .detail-add-btn {
            margin-top: 20px;
            width: 100%;
        }

        .agent-card {
            background: var(--bg-card);
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid var(--border-color);
            position: relative;
            clip-path: polygon(0 0, calc(100% - 15px) 0, 100% 15px, 100% 100%, 0 100%);
        }

        .agent-card:hover {
            border-color: var(--accent-attack);
            transform: translateY(-3px);
        }

        .agent-card.selected {
            border-color: var(--accent-attack);
            box-shadow: 0 0 20px rgba(255, 70, 85, 0.3);
        }

        .agent-card.disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        .agent-card.killed {
            opacity: 0.3;
            border-color: #ff0000;
        }

        .agent-card.killed::after {
            content: "KILLED";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.9);
            padding: 5px 20px;
            font-weight: 700;
            letter-spacing: 2px;
        }

        .card-portrait {
            width: 100%;
            height: 100px;
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-primary));
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
        }

        .card-name {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 8px;
            text-align: center;
            letter-spacing: 1px;
        }

        .card-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            font-size: 0.8rem;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.03);
        }

        .stat-dmg {
            color: #ff6b6b;
        }

        .stat-entry {
            color: #4ecdc4;
        }

        .stat-area {
            color: #ffe66d;
        }

        .stat-retake {
            color: #a29bfe;
        }

        .selected-deck {
            background: var(--bg-secondary);
            padding: 20px;
            margin-top: 20px;
            border: 1px solid var(--border-color);
        }

        .selected-deck h3 {
            margin-bottom: 15px;
            font-weight: 600;
            letter-spacing: 2px;
        }

        .deck-cards {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            min-height: 80px;
        }

        .deck-slot {
            width: 80px;
            height: 100px;
            background: var(--bg-card);
            border: 1px dashed var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        .deck-slot.filled {
            border-style: solid;
            border-color: var(--accent-attack);
        }

        .deck-slot .mini-name {
            font-size: 0.7rem;
            text-align: center;
            padding: 5px;
        }

        .credits {
            font-size: 1.8rem;
            color: var(--accent-gold);
            font-weight: 700;
        }

        .ability-list {
            margin-top: 10px;
        }

        .ability-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--bg-secondary);
            margin-bottom: 6px;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .ability-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-left-color: var(--accent-attack);
        }

        .ability-item.purchased {
            background: rgba(0, 200, 200, 0.15);
            border-left-color: var(--accent-defense);
        }

        .ability-name {
            font-weight: 600;
        }

        .ability-cost {
            color: var(--accent-gold);
            font-weight: 700;
        }

        .ability-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .round-container {
            text-align: center;
        }

        .phase-display {
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: 3px;
            margin: 30px 0;
            padding: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }

        .result-section {
            background: var(--bg-secondary);
            padding: 30px;
            margin: 20px 0;
            border: 1px solid var(--border-color);
        }

        .result-section h3 {
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 700;
            letter-spacing: 2px;
        }

        .stats-comparison {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 30px;
            align-items: center;
        }

        .stats-column {
            text-align: center;
        }

        .stats-column h4 {
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .stat-row {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 8px 0;
            font-size: 1rem;
        }

        .vs-divider {
            font-size: 1.5rem;
            color: var(--text-secondary);
            font-weight: 700;
        }

        .plant-badge {
            display: inline-block;
            padding: 15px 40px;
            font-size: 1.2rem;
            font-weight: 700;
            letter-spacing: 2px;
            margin: 20px 0;
            clip-path: polygon(10px 0, 100% 0, calc(100% - 10px) 100%, 0 100%);
        }

        .plant-badge.complete {
            background: var(--gradient-attack);
        }

        .plant-badge.incomplete {
            background: var(--gradient-defense);
            color: var(--bg-primary);
        }

        .kill-info {
            font-size: 1.5rem;
            margin: 15px 0;
            font-weight: 700;
        }

        .kill-select-grid {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin: 20px 0;
        }

        .kill-select-card {
            background: var(--bg-card);
            padding: 15px;
            cursor: pointer;
            border: 2px solid var(--border-color);
            transition: all 0.2s;
            width: 220px;
        }

        .kill-select-card:hover {
            border-color: var(--accent-attack);
        }

        .kill-select-card.selected {
            border-color: var(--accent-attack);
            background: rgba(255, 70, 85, 0.15);
        }

        .ability-badge {
            display: inline-block;
            padding: 2px 8px;
            font-size: 0.65rem;
            background: var(--accent-defense);
            color: var(--bg-primary);
            font-weight: 700;
            letter-spacing: 1px;
            margin-left: 5px;
        }

        .winner-display {
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: 3px;
            padding: 30px;
            margin: 30px 0;
            clip-path: polygon(15px 0, 100% 0, calc(100% - 15px) 100%, 0 100%);
        }

        .winner-display.attack {
            background: var(--gradient-attack);
        }

        .winner-display.defense {
            background: var(--gradient-defense);
            color: var(--bg-primary);
        }

        .winner-display.draw {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }

        #end-screen {
            text-align: center;
            padding: 50px;
        }

        .final-result {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 30px;
            letter-spacing: 5px;
        }

        .final-scores {
            font-size: 1.5rem;
            margin-bottom: 40px;
        }

        .fade-in {
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
    </style>
</head>

<body>
    <header class="game-header hidden" id="game-header">
        <div class="game-title">PROJECT V</div>
        <div class="game-info">
            <div class="info-item">
                <div class="info-label">ãƒ©ã‚¦ãƒ³ãƒ‰</div>
                <div class="info-value" id="round-display">1 / 4</div>
            </div>
            <div class="info-item">
                <div class="info-label">ã‚»ãƒƒãƒˆ</div>
                <div class="info-value" id="set-display">A</div>
            </div>
            <div class="score-display">
                <div class="score-box attack">
                    <div class="info-label" id="p1-role-label">P1 ATK</div>
                    <div class="info-value" id="p1-score">0</div>
                </div>
                <div class="score-box defense">
                    <div class="info-label" id="p2-role-label">P2 DEF</div>
                    <div class="info-value" id="p2-score">0</div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="title-screen">
            <h1 class="logo">PROJECT V</h1>
            <p class="subtitle">ã‚¿ã‚¯ãƒ†ã‚£ã‚«ãƒ«ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ </p>
            <button class="btn btn-primary" onclick="startGame()">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
        </div>

        <div id="pick-screen" class="hidden">
            <div class="pick-header">
                <h2>ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé¸æŠ</h2>
                <div class="player-indicator" id="current-picker">P1ã®ã‚¿ãƒ¼ãƒ³</div>
                <p style="margin-top:10px;color:var(--text-secondary);">5ä½“ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</p>
            </div>
            <div class="pick-layout">
                <div class="agent-list" id="agent-list"></div>
                <div class="agent-detail" id="agent-detail">
                    <p style="color:var(--text-secondary);text-align:center;padding:50px;">ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’é¸æŠã™ã‚‹ã¨è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                </div>
            </div>
            <div class="selected-deck">
                <h3>é¸æŠæ¸ˆã¿ (<span id="deck-count">0</span>/5)</h3>
                <div class="deck-cards" id="deck-cards"></div>
            </div>
            <div class="nav-buttons">
                <button class="btn btn-secondary" onclick="clearSelection()">ã‚¯ãƒªã‚¢</button>
                <button class="btn btn-primary" id="confirm-pick-btn" onclick="confirmPick()" disabled>ç¢ºå®š</button>
            </div>
        </div>

        <div id="buy-screen" class="hidden">
            <div class="pick-header">
                <h2>ãƒã‚¤ãƒ•ã‚§ãƒ¼ã‚º</h2>
                <div class="player-indicator" id="current-buyer">P1ã®ã‚¿ãƒ¼ãƒ³</div>
                <p style="margin-top:10px;color:var(--text-secondary);">ã‚¢ãƒ“ãƒªãƒ†ã‚£ã‚’è³¼å…¥ã—ã¦ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å¼·åŒ–</p>
            </div>
            <div id="buy-cards-container"></div>
            <div class="nav-buttons">
                <button class="btn btn-primary" id="confirm-buy-btn" onclick="confirmBuy()">è³¼å…¥å®Œäº†</button>
            </div>
        </div>

        <div id="round-screen" class="hidden">
            <div class="round-container">
                <div class="phase-display" id="phase-display">ROUND</div>
                <div id="round-content"></div>
            </div>
        </div>

        <div id="kill-screen" class="hidden">
            <div class="round-container">
                <h2 style="font-size:1.8rem;letter-spacing:3px;">ã‚­ãƒ«é¸æŠ</h2>
                <p id="kill-instruction" style="margin:20px 0;font-size:1.1rem;"></p>
                <div class="kill-select-grid" id="kill-select-grid"></div>
                <div class="nav-buttons">
                    <button class="btn btn-primary" id="confirm-kill-btn" onclick="confirmKillSelection()"
                        disabled>é¸æŠç¢ºå®š</button>
                </div>
            </div>
        </div>

        <div id="end-screen" class="hidden">
            <div class="final-result" id="final-result"></div>
            <div class="final-scores" id="final-scores"></div>
            <button class="btn btn-primary" onclick="location.reload()">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
        </div>
    </div>

    <script>
        const ABILITIES = {
            // JETT
            JT1: { id: 'JT1', name: 'TAILWIND', cost: 300, desc: 'DMG+50, ENTRY+1', type: 'stat', effect: { damage: 50, entry: 1 } },
            JT2: { id: 'JT2', name: 'UPDRAFT', cost: 300, desc: 'AREA+1', type: 'stat', effect: { area: 1 } },
            JT3: { id: 'JT3', name: 'CLOUDBURST', cost: 300, desc: 'ENTRY+2', type: 'stat', effect: { entry: 2 } },
            // ISO
            IS1: { id: 'IS1', name: 'UNDERCUT', cost: 300, desc: 'AREA+1', type: 'stat', effect: { area: 1 } },
            IS2: { id: 'IS2', name: 'DOUBLE TAP', cost: 300, desc: 'DMG+50', type: 'stat', effect: { damage: 50 } },
            IS3: { id: 'IS3', name: 'CONTINGENCY', cost: 300, desc: 'ENTRY+1', type: 'stat', effect: { entry: 1 } },
            // NEON
            NE1: { id: 'NE1', name: 'RELAY BOLT', cost: 300, desc: 'AREA+1', type: 'stat', effect: { area: 1 } },
            NE2: { id: 'NE2', name: 'HIGH GEAR', cost: 300, desc: 'KILL+1', type: 'rule', effect: { extraKill: 1 } },
            NE3: { id: 'NE3', name: 'FAST LANE', cost: 300, desc: 'ENTRY+1', type: 'stat', effect: { entry: 1 } },
            // ASTRA
            AS1: { id: 'AS1', name: 'NOVA PULSE', cost: 300, desc: 'RETAKE+1, AREA+1', type: 'stat', effect: { retake: 1, area: 1 } },
            AS2: { id: 'AS2', name: 'NEBULA', cost: 300, desc: 'RETAKE+1, AREA+1, ENTRY+1', type: 'stat', effect: { retake: 1, area: 1, entry: 1 } },
            AS3: { id: 'AS3', name: 'GRAVITY WELL', cost: 300, desc: 'ENTRY+1, AREA+1', type: 'stat', effect: { entry: 1, area: 1 } },
            // CLOVE
            CL1: { id: 'CL1', name: 'MEDDLE', cost: 300, desc: 'DMG+50', type: 'stat', effect: { damage: 50 } },
            CL2: { id: 'CL2', name: 'RUSE', cost: 300, desc: 'AREA+1', type: 'stat', effect: { area: 1 } },
            CL3: { id: 'CL3', name: 'PICK-ME-UP', cost: 300, desc: 'æ•µDMG-50', type: 'rule', effect: { reduceEnemyDamage: 50 } },
            // VIPER
            VP1: { id: 'VP1', name: 'POISON CLOUD', cost: 300, desc: 'AREA+1, DMG+50', type: 'stat', effect: { area: 1, damage: 50 } },
            VP2: { id: 'VP2', name: 'TOXIC SCREEN', cost: 300, desc: 'AREA+1, RETAKE+1', type: 'stat', effect: { area: 1, retake: 1 } },
            VP3: { id: 'VP3', name: 'SNAKE BITE', cost: 300, desc: 'AREA+2', type: 'stat', effect: { area: 2 } },
            // SOVA
            SV1: { id: 'SV1', name: 'SHOCK BOLT', cost: 300, desc: 'DMG+50', type: 'stat', effect: { damage: 50 } },
            SV2: { id: 'SV2', name: 'RECON BOLT', cost: 300, desc: 'RETAKE+1, ENTRY+1', type: 'stat', effect: { retake: 1, entry: 1 } },
            SV3: { id: 'SV3', name: 'OWL DRONE', cost: 300, desc: 'RETAKE+1, ENTRY+1', type: 'stat', effect: { retake: 1, entry: 1 } },
            // KAYO
            KY1: { id: 'KY1', name: 'FRAG/MENT', cost: 300, desc: 'DMG+50', type: 'stat', effect: { damage: 50 } },
            KY2: { id: 'KY2', name: 'FLASH/DRIVE', cost: 300, desc: 'RETAKE+1, ENTRY+1', type: 'stat', effect: { retake: 1, entry: 1 } },
            KY3: { id: 'KY3', name: 'ZERO/POINT', cost: 300, desc: 'RETAKE+1, ENTRY+1', type: 'stat', effect: { retake: 1, entry: 1 } },
            // TEJO
            TJ1: { id: 'TJ1', name: 'SPECIAL DELIVERY', cost: 300, desc: 'DMG+50', type: 'stat', effect: { damage: 50 } },
            TJ2: { id: 'TJ2', name: 'STEALTH DRONE', cost: 300, desc: 'RETAKE+1, ENTRY+1', type: 'stat', effect: { retake: 1, entry: 1 } },
            TJ3: { id: 'TJ3', name: 'GUIDED SALVO', cost: 300, desc: 'RETAKE+1, ENTRY+1', type: 'stat', effect: { retake: 1, entry: 1 } },
            // KILLJOY
            KJ1: { id: 'KJ1', name: 'ALARMBOT', cost: 300, desc: 'AREA+2', type: 'stat', effect: { area: 2 } },
            KJ2: { id: 'KJ2', name: 'TURRET', cost: 300, desc: 'AREA+2, DMG+30', type: 'stat', effect: { area: 2, damage: 30 } },
            KJ3: { id: 'KJ3', name: 'NANOSWARM', cost: 300, desc: 'DMG+50', type: 'stat', effect: { damage: 50 } },
            // CYPHER
            CY1: { id: 'CY1', name: 'TRAPWIRE', cost: 300, desc: 'AREA+2', type: 'stat', effect: { area: 2 } },
            CY2: { id: 'CY2', name: 'SPY CAM', cost: 300, desc: 'AREA+2, DMG+30', type: 'stat', effect: { area: 2, damage: 30 } },
            CY3: { id: 'CY3', name: 'CYBER CAGE', cost: 300, desc: 'DMG+50', type: 'stat', effect: { damage: 50 } },
            // CHAMBER
            CH1: { id: 'CH1', name: 'TRADEMARK', cost: 300, desc: 'AREA+2', type: 'stat', effect: { area: 2 } },
            CH2: { id: 'CH2', name: 'HEADHUNTER', cost: 300, desc: 'AREA+2, DMG+30', type: 'stat', effect: { area: 2, damage: 30 } },
            CH3: { id: 'CH3', name: 'RENDEZVOUS', cost: 300, desc: 'DMG+50', type: 'stat', effect: { damage: 50 } }
        };

        const AGENTS = [
            { id: '001', name: 'JETT', icon: 'ğŸ’¨', baseStats: { damage: 100, entry: 2, area: 1, retake: 1 }, abilities: ['JT1', 'JT2', 'JT3'] },
            { id: '002', name: 'ISO', icon: 'ğŸ”®', baseStats: { damage: 100, entry: 1, area: 1, retake: 1 }, abilities: ['IS1', 'IS2', 'IS3'] },
            { id: '003', name: 'NEON', icon: 'âš¡', baseStats: { damage: 100, entry: 2, area: 1, retake: 1 }, abilities: ['NE1', 'NE2', 'NE3'] },
            { id: '004', name: 'ASTRA', icon: 'ğŸŒŸ', baseStats: { damage: 100, entry: 1, area: 2, retake: 2 }, abilities: ['AS1', 'AS2', 'AS3'] },
            { id: '005', name: 'CLOVE', icon: 'ğŸ¦‹', baseStats: { damage: 100, entry: 1, area: 1, retake: 1 }, abilities: ['CL1', 'CL2', 'CL3'] },
            { id: '006', name: 'VIPER', icon: 'ğŸ', baseStats: { damage: 100, entry: 1, area: 2, retake: 1 }, abilities: ['VP1', 'VP2', 'VP3'] },
            { id: '007', name: 'SOVA', icon: 'ğŸ¦…', baseStats: { damage: 100, entry: 1, area: 1, retake: 2 }, abilities: ['SV1', 'SV2', 'SV3'] },
            { id: '008', name: 'KAYO', icon: 'ğŸ¤–', baseStats: { damage: 100, entry: 1, area: 1, retake: 2 }, abilities: ['KY1', 'KY2', 'KY3'] },
            { id: '009', name: 'TEJO', icon: 'ğŸ¯', baseStats: { damage: 100, entry: 1, area: 1, retake: 2 }, abilities: ['TJ1', 'TJ2', 'TJ3'] },
            { id: '010', name: 'KILLJOY', icon: 'ğŸ”§', baseStats: { damage: 100, entry: 1, area: 2, retake: 1 }, abilities: ['KJ1', 'KJ2', 'KJ3'] },
            { id: '011', name: 'CYPHER', icon: 'ğŸ‘ï¸', baseStats: { damage: 100, entry: 1, area: 2, retake: 1 }, abilities: ['CY1', 'CY2', 'CY3'] },
            { id: '012', name: 'CHAMBER', icon: 'ğŸ©', baseStats: { damage: 100, entry: 1, area: 2, retake: 1 }, abilities: ['CH1', 'CH2', 'CH3'] }
        ];

        let gameState = {
            phase: 'title', roundIndex: 1, setIndex: 1,
            roles: { attacker: 'P1', defender: 'P2' },
            scores: { P1: 0, P2: 0 },
            credits: { P1: 1500, P2: 1500 },
            decks: { P1: [], P2: [] },
            purchases: { P1: {}, P2: {} },
            killed: { P1: [], P2: [] },
            currentPicker: 'P1', currentBuyer: 'P1',
            tempSelection: [], plantComplete: false, computed: null,
            killCounts: { P1: 0, P2: 0 }, killSelecting: null, tempKillSelection: []
        };

        function $(id) { return document.getElementById(id); }
        function showScreen(screenId) {
            ['title-screen', 'pick-screen', 'buy-screen', 'round-screen', 'kill-screen', 'end-screen'].forEach(id => $(id).classList.add('hidden'));
            $(screenId).classList.remove('hidden');
            $('game-header').classList.toggle('hidden', screenId === 'title-screen');
        }
        function updateHeader() {
            $('round-display').textContent = `${gameState.roundIndex} / 4`;
            $('set-display').textContent = gameState.setIndex === 1 ? 'A' : 'B';
            $('p1-score').textContent = gameState.scores.P1;
            $('p2-score').textContent = gameState.scores.P2;
            const p1Role = gameState.roles.attacker === 'P1' ? 'ATK' : 'DEF';
            const p2Role = gameState.roles.attacker === 'P2' ? 'ATK' : 'DEF';
            $('p1-role-label').textContent = `P1 ${p1Role}`;
            $('p2-role-label').textContent = `P2 ${p2Role}`;
        }

        function startGame() {
            gameState.roles.attacker = Math.random() < 0.5 ? 'P1' : 'P2';
            gameState.roles.defender = gameState.roles.attacker === 'P1' ? 'P2' : 'P1';
            gameState.currentPicker = 'P1';
            showScreen('pick-screen');
            renderAgentGrid();
            updatePickerUI();
        }

        function renderAgentGrid() {
            // VALORANTé¢¨ï¼šå·¦ã«ã‚¿ã‚¤ãƒ«ä¸€è¦§ã€å³ã«è©³ç´°ãƒ‘ãƒãƒ«
            $('agent-list').innerHTML = AGENTS.map(agent => `
                <div class="agent-tile" data-id="${agent.id}" onclick="showAgentDetail('${agent.id}')">
                    <div class="tile-icon">${agent.icon}</div>
                    <div class="tile-name">${agent.name}</div>
                </div>
            `).join('');
            gameState.selectedAgentId = null;
            updateAgentTileStates();
        }

        function showAgentDetail(agentId) {
            const agent = AGENTS.find(a => a.id === agentId);
            if (!agent) return;
            gameState.selectedAgentId = agentId;

            // ã‚¿ã‚¤ãƒ«ã®activeçŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.agent-tile').forEach(t => t.classList.remove('active'));
            document.querySelector(`.agent-tile[data-id="${agentId}"]`)?.classList.add('active');

            const isAlreadyPicked = gameState.tempSelection.includes(agentId) ||
                gameState.decks.P1.some(a => a.id === agentId) ||
                gameState.decks.P2.some(a => a.id === agentId);

            $('agent-detail').innerHTML = `
                <div class="detail-header">
                    <div class="detail-icon">${agent.icon}</div>
                    <div class="detail-name">${agent.name}</div>
                </div>
                <div class="detail-abilities">
                    <h4 style="margin-bottom:15px;color:var(--text-secondary);font-size:0.9rem;">ã‚¢ãƒ“ãƒªãƒ†ã‚£</h4>
                    ${agent.abilities.map(abilityId => {
                const ability = ABILITIES[abilityId];
                return `
                            <div class="detail-ability">
                                <div class="detail-ability-name">${ability.name}</div>
                                <div class="detail-ability-desc">åŠ¹æœ: ${ability.desc}</div>
                                <div class="detail-ability-cost">ä¾¡æ ¼: ${ability.cost} ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ</div>
                            </div>
                        `;
            }).join('')}
                </div>
                ${!isAlreadyPicked && gameState.tempSelection.length < 5 ? `
                    <button class="btn btn-primary detail-add-btn" onclick="addAgentToSelection('${agentId}')">é¸æŠã«è¿½åŠ </button>
                ` : isAlreadyPicked ? `
                    <button class="btn btn-secondary detail-add-btn" onclick="removeAgentFromSelection('${agentId}')" ${gameState.tempSelection.includes(agentId) ? '' : 'disabled'}>é¸æŠã‹ã‚‰å¤–ã™</button>
                ` : `
                    <p style="text-align:center;color:var(--text-secondary);margin-top:20px;">5ä½“é¸æŠæ¸ˆã¿</p>
                `}
            `;
        }

        function addAgentToSelection(agentId) {
            if (gameState.tempSelection.length >= 5) return;
            if (!gameState.tempSelection.includes(agentId)) {
                gameState.tempSelection.push(agentId);
                updateDeckDisplay();
                updateAgentTileStates();
                showAgentDetail(agentId);
            }
        }

        function removeAgentFromSelection(agentId) {
            const idx = gameState.tempSelection.indexOf(agentId);
            if (idx > -1) {
                gameState.tempSelection.splice(idx, 1);
                updateDeckDisplay();
                updateAgentTileStates();
                showAgentDetail(agentId);
            }
        }

        function updateAgentTileStates() {
            document.querySelectorAll('.agent-tile').forEach(tile => {
                const id = tile.dataset.id;
                const isPicked = gameState.tempSelection.includes(id) ||
                    gameState.decks.P1.some(a => a.id === id) ||
                    gameState.decks.P2.some(a => a.id === id);
                tile.classList.toggle('picked', isPicked);
            });
        }

        function selectAgent(agentId) {
            // æ—§é–¢æ•°ï¼ˆäº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
            addAgentToSelection(agentId);
        }

        function updateDeckDisplay() {
            const deckCards = $('deck-cards');
            $('deck-count').textContent = gameState.tempSelection.length;
            deckCards.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                const agentId = gameState.tempSelection[i];
                if (agentId) {
                    const agent = AGENTS.find(a => a.id === agentId);
                    deckCards.innerHTML += `<div class="deck-slot filled"><div class="mini-name">${agent.icon}<br>${agent.name}</div></div>`;
                } else {
                    deckCards.innerHTML += `<div class="deck-slot">?</div>`;
                }
            }
            $('confirm-pick-btn').disabled = gameState.tempSelection.length !== 5;
        }

        function clearSelection() {
            gameState.tempSelection = [];
            updateDeckDisplay();
            updateAgentTileStates();
            $('agent-detail').innerHTML = '<p style="color:var(--text-secondary);text-align:center;padding:50px;">ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’é¸æŠã™ã‚‹ã¨è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>';
        }

        function updatePickerUI() {
            const indicator = $('current-picker');
            indicator.textContent = `${gameState.currentPicker}ã®ã‚¿ãƒ¼ãƒ³`;
            indicator.className = 'player-indicator ' + (gameState.currentPicker === 'P1' ? 'p1' : 'p2');
            updateAgentTileStates();
            gameState.tempSelection = [];
            updateDeckDisplay();
            $('agent-detail').innerHTML = '<p style="color:var(--text-secondary);text-align:center;padding:50px;">ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’é¸æŠã™ã‚‹ã¨è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>';
        }

        function confirmPick() {
            const selectedAgents = gameState.tempSelection.map(id => {
                const agent = AGENTS.find(a => a.id === id);
                return { ...agent, currentStats: { ...agent.baseStats }, killed: false };
            });
            gameState.decks[gameState.currentPicker] = selectedAgents;
            if (gameState.currentPicker === 'P1') { gameState.currentPicker = 'P2'; updatePickerUI(); }
            else { startBuyPhase(); }
        }

        function startBuyPhase() {
            gameState.credits = { P1: 1500, P2: 1500 };
            gameState.purchases = { P1: {}, P2: {} };
            gameState.currentBuyer = 'P1';
            updateHeader();
            showScreen('buy-screen');
            renderBuyPhase();
        }

        function renderBuyPhase() {
            const buyer = gameState.currentBuyer;
            $('current-buyer').textContent = `${buyer}ã®ã‚¿ãƒ¼ãƒ³`;
            $('current-buyer').className = 'player-indicator ' + (buyer === 'P1' ? 'p1' : 'p2');
            const deck = gameState.decks[buyer];
            const purchases = gameState.purchases[buyer];

            $('buy-cards-container').innerHTML = `
            <div style="text-align:center;margin-bottom:20px;">
                <span class="credits">ğŸ’° æ®‹ã‚Šã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ: ${gameState.credits[buyer]}</span>
            </div>
            <div class="agent-grid">
                ${deck.map(agent => {
                const agentPurchases = purchases[agent.id] || [];
                return `
                        <div class="agent-card">
                            <div class="card-portrait">${agent.icon}</div>
                            <div class="card-name">${agent.name}</div>
                            <div class="ability-list">
                                ${agent.abilities.map(abilityId => {
                    const ability = ABILITIES[abilityId];
                    const purchased = agentPurchases.includes(abilityId);
                    const canAfford = gameState.credits[buyer] >= ability.cost;
                    return `
                                        <div class="ability-item ${purchased ? 'purchased' : ''}" 
                                             onclick="toggleAbility('${agent.id}', '${abilityId}')"
                                             style="${!purchased && !canAfford ? 'opacity:0.4' : 'cursor:pointer'}">
                                            <div>
                                                <div class="ability-name">${ability.name}${purchased ? '<span class="ability-badge">è³¼å…¥æ¸ˆ</span>' : ''}</div>
                                                <div class="ability-desc">${ability.desc}</div>
                                            </div>
                                            <div class="ability-cost">${ability.cost}</div>
                                        </div>
                                    `;
                }).join('')}
                            </div>
                        </div>
                    `;
            }).join('')}
            </div>
        `;
        }

        function toggleAbility(agentId, abilityId) {
            const buyer = gameState.currentBuyer;
            const ability = ABILITIES[abilityId];
            if (!gameState.purchases[buyer][agentId]) gameState.purchases[buyer][agentId] = [];
            const purchases = gameState.purchases[buyer][agentId];
            const idx = purchases.indexOf(abilityId);
            if (idx > -1) { purchases.splice(idx, 1); gameState.credits[buyer] += ability.cost; }
            else if (gameState.credits[buyer] >= ability.cost) { purchases.push(abilityId); gameState.credits[buyer] -= ability.cost; }
            renderBuyPhase();
        }

        function confirmBuy() {
            if (gameState.currentBuyer === 'P1') { gameState.currentBuyer = 'P2'; renderBuyPhase(); }
            else { startRound(); }
        }

        function startRound() {
            gameState.killed = { P1: [], P2: [] };
            gameState.decks.P1.forEach(a => a.killed = false);
            gameState.decks.P2.forEach(a => a.killed = false);
            showScreen('round-screen');
            showRoundReady();
        }

        function showRoundReady() {
            $('phase-display').textContent = `âš”ï¸ ãƒ©ã‚¦ãƒ³ãƒ‰ ${gameState.roundIndex}`;
            $('round-content').innerHTML = `
            <div class="result-section fade-in">
                <h3>ãƒ©ã‚¦ãƒ³ãƒ‰é–‹å§‹</h3>
                <p style="margin:20px 0;">ç”Ÿå­˜ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é›†è¨ˆã—ã¾ã™</p>
                <div class="nav-buttons">
                    <button class="btn btn-primary" onclick="stepCalculateStats()">é›†è¨ˆã™ã‚‹</button>
                </div>
            </div>
        `;
        }

        function stepCalculateStats() {
            $('phase-display').textContent = 'ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é›†è¨ˆ';
            const computed = calculateStats();
            gameState.computed = computed;
            $('round-content').innerHTML = `
            <div class="result-section fade-in">
                <h3>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é›†è¨ˆçµæœ</h3>
                <div class="stats-comparison">
                    <div class="stats-column">
                        <h4>${gameState.roles.attacker} (æ”»æ’ƒ)</h4>
                        <div class="stat-row stat-dmg">ğŸ’¥ ãƒ€ãƒ¡ãƒ¼ã‚¸: ${computed[gameState.roles.attacker].damage}</div>
                        <div class="stat-row stat-entry">ğŸš€ ã‚¨ãƒ³ãƒˆãƒªãƒ¼: ${computed[gameState.roles.attacker].entry}</div>
                        <div class="stat-row stat-area">ğŸ¯ ã‚¨ãƒªã‚¢: ${computed[gameState.roles.attacker].area}</div>
                        <div class="stat-row stat-retake">ğŸ”„ ãƒªãƒ†ã‚¤ã‚¯: ${computed[gameState.roles.attacker].retake}</div>
                    </div>
                    <div class="vs-divider">VS</div>
                    <div class="stats-column">
                        <h4>${gameState.roles.defender} (é˜²è¡›)</h4>
                        <div class="stat-row stat-dmg">ğŸ’¥ ãƒ€ãƒ¡ãƒ¼ã‚¸: ${computed[gameState.roles.defender].damage}</div>
                        <div class="stat-row stat-entry">ğŸš€ ã‚¨ãƒ³ãƒˆãƒªãƒ¼: ${computed[gameState.roles.defender].entry}</div>
                        <div class="stat-row stat-area">ğŸ¯ ã‚¨ãƒªã‚¢: ${computed[gameState.roles.defender].area}</div>
                        <div class="stat-row stat-retake">ğŸ”„ ãƒªãƒ†ã‚¤ã‚¯: ${computed[gameState.roles.defender].retake}</div>
                    </div>
                </div>
                <div class="nav-buttons" style="margin-top:30px;">
                    <button class="btn btn-primary" onclick="stepPlantDetermination()">ãƒ—ãƒ©ãƒ³ãƒˆåˆ¤å®šã¸</button>
                </div>
            </div>
        `;
        }

        function stepPlantDetermination() {
            $('phase-display').textContent = 'ğŸ’£ ãƒ—ãƒ©ãƒ³ãƒˆåˆ¤å®š';
            const atk = gameState.roles.attacker, def = gameState.roles.defender;
            const computed = gameState.computed;
            let attackEntry = computed[atk].entry;
            Object.values(gameState.purchases[atk]).flat().forEach(id => {
                if (ABILITIES[id].effect.plantEntryBonus) attackEntry += ABILITIES[id].effect.plantEntryBonus;
            });
            const plantComplete = attackEntry > computed[def].area;
            gameState.plantComplete = plantComplete;
            $('round-content').innerHTML = `
            <div class="result-section fade-in">
                <h3>ãƒ—ãƒ©ãƒ³ãƒˆåˆ¤å®š</h3>
                <p style="margin:15px 0;">æ”»æ’ƒã‚¨ãƒ³ãƒˆãƒªãƒ¼(${attackEntry}) vs é˜²è¡›ã‚¨ãƒªã‚¢(${computed[def].area})</p>
                <div class="plant-badge ${plantComplete ? 'complete' : 'incomplete'}">
                    ${plantComplete ? 'ğŸ’£ ãƒ—ãƒ©ãƒ³ãƒˆå®Œäº†!' : 'ğŸ›¡ï¸ ãƒ—ãƒ©ãƒ³ãƒˆé˜»æ­¢'}
                </div>
                <div class="nav-buttons" style="margin-top:30px;">
                    <button class="btn btn-primary" onclick="stepKillCalculation()">ã‚­ãƒ«æ•°è¨ˆç®—ã¸</button>
                </div>
            </div>
        `;
        }

        function stepKillCalculation() {
            $('phase-display').textContent = 'âš”ï¸ ã‚­ãƒ«æ•°è¨ˆç®—';
            const killCounts = calculateKills(gameState.computed);
            gameState.killCounts = killCounts;
            const atk = gameState.roles.attacker, def = gameState.roles.defender;
            const hasKills = killCounts[atk] > 0 || killCounts[def] > 0;
            $('round-content').innerHTML = `
            <div class="result-section fade-in">
                <h3>ã‚­ãƒ«æ•°è¨ˆç®—çµæœ</h3>
                <p style="margin:10px 0;font-size:0.85rem;color:var(--text-secondary);">150ãƒ€ãƒ¡ãƒ¼ã‚¸ = 1ã‚­ãƒ«</p>
                <div class="stats-comparison">
                    <div class="stats-column">
                        <h4>${atk} (æ”»æ’ƒ)</h4>
                        <div class="kill-info">ğŸ—¡ï¸ ${killCounts[atk]} ã‚­ãƒ«</div>
                </div>
                    <div class="vs-divider">âš”ï¸</div>
                    <div class="stats-column">
                        <h4>${def} (é˜²è¡›)</h4>
                        <div class="kill-info">ğŸ—¡ï¸ ${killCounts[def]} ã‚­ãƒ«</div>
                    </div>
                </div>
                <div class="nav-buttons" style="margin-top:30px;">
                    <button class="btn btn-primary" onclick="${hasKills ? 'stepKillSelection()' : 'stepWinnerDetermination()'}">
                        ${hasKills ? 'ã‚­ãƒ«é¸æŠã¸' : 'å‹æ•—åˆ¤å®š'}
                    </button>
                </div>
            </div>
        `;
        }

        async function stepKillSelection() {
            for (const victim of ['P1', 'P2']) {
                const killer = victim === 'P1' ? 'P2' : 'P1';
                const killCount = gameState.killCounts[killer];
                if (killCount > 0) {
                    gameState.killSelecting = victim;
                    gameState.tempKillSelection = [];
                    await showKillSelection(victim, killCount);
                }
            }
            showScreen('round-screen');
            $('phase-display').textContent = 'â˜ ï¸ ã‚­ãƒ«ç¢ºå®š';
            const atk = gameState.roles.attacker, def = gameState.roles.defender;
            const atkAlive = gameState.decks[atk].filter(a => !a.killed).length;
            const defAlive = gameState.decks[def].filter(a => !a.killed).length;
            $('round-content').innerHTML = `
                < div class="result-section fade-in" >
                <h3>ã‚­ãƒ«ç¢ºå®š</h3>
                <div class="stats-comparison">
                    <div class="stats-column"><h4>${atk} (æ”»æ’ƒ)</h4><div class="kill-info">ç”Ÿå­˜: ${atkAlive}ä½“</div></div>
                    <div class="vs-divider">âš”ï¸</div>
                    <div class="stats-column"><h4>${def} (é˜²è¡›)</h4><div class="kill-info">ç”Ÿå­˜: ${defAlive}ä½“</div></div>
                </div>
                <div class="nav-buttons" style="margin-top:30px;">
                    <button class="btn btn-primary" onclick="stepWinnerDetermination()">å‹æ•—åˆ¤å®š</button>
                </div>
            </div >
                `;
        }

        function calculateStats() {
            const computed = { P1: { damage: 0, entry: 0, area: 0, retake: 0 }, P2: { damage: 0, entry: 0, area: 0, retake: 0 } };
            ['P1', 'P2'].forEach(player => {
                gameState.decks[player].forEach(agent => {
                    if (agent.killed) return;
                    computed[player].damage += agent.baseStats.damage;
                    computed[player].entry += agent.baseStats.entry;
                    computed[player].area += agent.baseStats.area;
                    computed[player].retake += agent.baseStats.retake;
                    (gameState.purchases[player][agent.id] || []).forEach(abilityId => {
                        const ability = ABILITIES[abilityId];
                        if (ability.type === 'stat') {
                            if (ability.effect.damage) computed[player].damage += ability.effect.damage;
                            if (ability.effect.entry) computed[player].entry += ability.effect.entry;
                            if (ability.effect.area) computed[player].area += ability.effect.area;
                            if (ability.effect.retake) computed[player].retake += ability.effect.retake;
                        }
                    });
                });
            });
            ['P1', 'P2'].forEach(player => {
                const opponent = player === 'P1' ? 'P2' : 'P1';
                Object.values(gameState.purchases[player]).flat().forEach(abilityId => {
                    if (ABILITIES[abilityId].effect.reduceEnemyDamage) {
                        computed[opponent].damage = Math.max(0, computed[opponent].damage - ABILITIES[abilityId].effect.reduceEnemyDamage);
                    }
                });
            });
            ['P1', 'P2'].forEach(player => {
                const opponent = player === 'P1' ? 'P2' : 'P1';
                const playerAlive = gameState.decks[player].filter(a => !a.killed).length;
                const opponentAlive = gameState.decks[opponent].filter(a => !a.killed).length;
                if (playerAlive < opponentAlive) {
                    Object.values(gameState.purchases[player]).flat().forEach(abilityId => {
                        if (ABILITIES[abilityId].effect.underdog) computed[player].damage += ABILITIES[abilityId].effect.underdog;
                    });
                }
            });
            return computed;
        }

        function calculateKills(computed) {
            const killCounts = {};
            ['P1', 'P2'].forEach(player => {
                const opponent = player === 'P1' ? 'P2' : 'P1';
                const opponentAlive = gameState.decks[opponent].filter(a => !a.killed).length;
                let kills = Math.floor(computed[player].damage / 150);
                kills = Math.min(kills, opponentAlive);
                killCounts[player] = kills;
            });
            ['P1', 'P2'].forEach(player => {
                Object.values(gameState.purchases[player]).flat().forEach(abilityId => {
                    if (ABILITIES[abilityId].effect.extraKill) {
                        const opponent = player === 'P1' ? 'P2' : 'P1';
                        const opponentAlive = gameState.decks[opponent].filter(a => !a.killed).length;
                        if (killCounts[player] < opponentAlive) {
                            killCounts[player] = Math.min(killCounts[player] + ABILITIES[abilityId].effect.extraKill, opponentAlive);
                        }
                    }
                });
            });
            return killCounts;
        }

        function showKillSelection(player, killCount) {
            return new Promise(resolve => {
                showScreen('kill-screen');
                $('kill-instruction').textContent = `${player}: ${killCount}ä½“ã‚’é¸æŠã—ã¦ã‚­ãƒ«ã•ã‚Œã¾ã™`;
                const deck = gameState.decks[player].filter(a => !a.killed);
                const purchases = gameState.purchases[player];
                $('kill-select-grid').innerHTML = deck.map(agent => {
                    const agentPurchases = purchases[agent.id] || [];
                    return `
                    <div class="kill-select-card" data-id="${agent.id}" onclick="toggleKillSelect('${agent.id}')">
                        <div class="card-portrait" style="height:60px;font-size:2rem;">${agent.icon}</div>
                        <div class="card-name">${agent.name}</div>
                        <div style="font-size:0.7rem;border-top:1px solid var(--border-color);padding-top:8px;margin-top:8px;">
                            ${agent.abilities.map(abilityId => {
                        const ability = ABILITIES[abilityId];
                        const purchased = agentPurchases.includes(abilityId);
                        return `<div style="display:flex;justify-content:space-between;align-items:center;margin:3px 0;${purchased ? 'color:var(--accent-defense);' : 'color:var(--text-secondary);'}">
                                    <span>${ability.name}</span>
                                    ${purchased ? '<span class="ability-badge">è³¼å…¥æ¸ˆ</span>' : '<span style="opacity:0.5">' + ability.cost + '</span>'}
                                </div>`;
                    }).join('')}
                        </div>
                    </div>
                `;
                }).join('');
                $('confirm-kill-btn').disabled = true;
                window.currentKillResolve = resolve;
                window.requiredKills = killCount;
            });
        }

        function toggleKillSelect(agentId) {
            const card = document.querySelector(`.kill-select-card[data-id="${agentId}"]`);
            const idx = gameState.tempKillSelection.indexOf(agentId);
            if (idx > -1) { gameState.tempKillSelection.splice(idx, 1); card.classList.remove('selected'); }
            else if (gameState.tempKillSelection.length < window.requiredKills) { gameState.tempKillSelection.push(agentId); card.classList.add('selected'); }
            $('confirm-kill-btn').disabled = gameState.tempKillSelection.length !== window.requiredKills;
        }

        function confirmKillSelection() {
            const player = gameState.killSelecting;
            gameState.tempKillSelection.forEach(agentId => {
                const agent = gameState.decks[player].find(a => a.id === agentId);
                if (agent) agent.killed = true;
                gameState.killed[player].push(agentId);
            });
            gameState.tempKillSelection = [];
            showScreen('round-screen');
            if (window.currentKillResolve) window.currentKillResolve();
        }

        function stepWinnerDetermination() {
            $('phase-display').textContent = 'ğŸ† å‹æ•—åˆ¤å®š';
            const atk = gameState.roles.attacker, def = gameState.roles.defender;
            const atkAlive = gameState.decks[atk].filter(a => !a.killed).length;
            const defAlive = gameState.decks[def].filter(a => !a.killed).length;
            let winner = null, reason = '';
            let forceAttackWin = false;
            if (gameState.plantComplete) {
                ['P1', 'P2'].forEach(p => {
                    Object.values(gameState.purchases[p]).flat().forEach(id => {
                        if (ABILITIES[id].effect.forceAttackWin) forceAttackWin = true;
                    });
                });
            }
            if (atkAlive === 0 && defAlive === 0) {
                winner = (gameState.plantComplete || forceAttackWin) ? atk : def;
                reason = (gameState.plantComplete || forceAttackWin) ? 'ãƒ—ãƒ©ãƒ³ãƒˆå®Œäº†ã«ã‚ˆã‚Šæ”»æ’ƒå‹åˆ©' : 'ãƒ—ãƒ©ãƒ³ãƒˆé˜»æ­¢ã«ã‚ˆã‚Šé˜²è¡›å‹åˆ©';
            } else if (atkAlive === 0) { winner = def; reason = 'æ”»æ’ƒå´å…¨æ»…ï¼é˜²è¡›å‹åˆ©'; }
            else if (defAlive === 0) { winner = atk; reason = 'é˜²è¡›å´å…¨æ»…ï¼æ”»æ’ƒå‹åˆ©'; }
            else {
                let atkArea = 0, defRetake = 0;
                gameState.decks[atk].forEach(a => { if (!a.killed) atkArea += a.baseStats.area; });
                gameState.decks[def].forEach(a => { if (!a.killed) defRetake += a.baseStats.retake; });
                Object.values(gameState.purchases[atk]).flat().forEach(id => { if (ABILITIES[id].effect.areaBonus) atkArea += ABILITIES[id].effect.areaBonus; });
                Object.values(gameState.purchases[def]).flat().forEach(id => { if (ABILITIES[id].effect.retakeBonus) defRetake += ABILITIES[id].effect.retakeBonus; });
                if (atkArea > defRetake) { winner = atk; reason = `ã‚¨ãƒªã‚¢(${atkArea}) > ãƒªãƒ†ã‚¤ã‚¯(${defRetake}) ã§æ”»æ’ƒå‹åˆ©`; }
                else if (defRetake > atkArea) { winner = def; reason = `ãƒªãƒ†ã‚¤ã‚¯(${defRetake}) > ã‚¨ãƒªã‚¢(${atkArea}) ã§é˜²è¡›å‹åˆ©`; }
                else { winner = gameState.plantComplete ? atk : def; reason = `åŒå€¤ï¼${gameState.plantComplete ? 'ãƒ—ãƒ©ãƒ³ãƒˆå®Œäº†ã§æ”»æ’ƒ' : 'ãƒ—ãƒ©ãƒ³ãƒˆé˜»æ­¢ã§é˜²è¡›'}å‹åˆ©`; }
            }
            gameState.scores[winner]++;
            updateHeader();
            const winnerRole = winner === atk ? 'attack' : 'defense';
            $('round-content').innerHTML = `
            <div class="result-section fade-in">
                <h3>ãƒ©ã‚¦ãƒ³ãƒ‰çµæœ</h3>
                <p style="margin:15px 0;">æ”»æ’ƒç”Ÿå­˜: ${atkAlive}ä½“ / é˜²è¡›ç”Ÿå­˜: ${defAlive}ä½“</p>
                <div class="winner-display ${winnerRole}">${winner}ã®å‹åˆ©ï¼</div>
                <p style="font-size:1rem;">${reason}</p>
                <div class="nav-buttons" style="margin-top:30px;">
                    <button class="btn btn-primary" onclick="nextRound()">æ¬¡ã¸</button>
                </div>
            </div>
        `;
        }

        function nextRound() {
            if (gameState.scores.P1 >= 3 || gameState.scores.P2 >= 3) { endGame(); return; }
            gameState.roundIndex++;
            if (gameState.roundIndex > 4) { endGame(); return; }
            if (gameState.roundIndex === 3) {
                gameState.setIndex = 2;
                const temp = gameState.roles.attacker;
                gameState.roles.attacker = gameState.roles.defender;
                gameState.roles.defender = temp;
            }
            gameState.decks.P1.forEach(a => a.killed = false);
            gameState.decks.P2.forEach(a => a.killed = false);
            startBuyPhase();
        }

        function endGame() {
            showScreen('end-screen');
            let result = '', resultClass = '';
            if (gameState.scores.P1 > gameState.scores.P2) { result = 'ğŸ† P1 ã®å‹åˆ©ï¼ ğŸ†'; resultClass = 'attack'; }
            else if (gameState.scores.P2 > gameState.scores.P1) { result = 'ğŸ† P2 ã®å‹åˆ©ï¼ ğŸ†'; resultClass = 'defense'; }
            else { result = 'ğŸ¤ å¼•ãåˆ†ã‘ ğŸ¤'; resultClass = 'draw'; }
            $('final-result').textContent = result;
            $('final-result').className = 'final-result winner-display ' + resultClass;
            $('final-scores').textContent = `P1: ${gameState.scores.P1} - P2: ${gameState.scores.P2}`;
        }
    </script>
</body>

</html>